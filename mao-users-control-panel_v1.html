<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAOMAO-會員列表</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/mao.css">
    <link rel="stylesheet" href="css/mao_web.css">
    <link rel="stylesheet" href="css/all.min.css">
    <link rel="stylesheet" href="css/animate.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        .search-bar {
            background-color: var(--maocolor08);
            border: 1px solid var(--maocolor06);
            color: var(--maocolor05);
        }

        .search-bar::placeholder {
            color: var(--maocolor07);
        }

        .search-bar:focus {
            border-color: var(--maocolor04);
            box-shadow: 0 0 0 0.2rem rgba(201, 168, 141, 0.25);
        }

        .search-bar+.btn {
            color: var(--maocolor05);
        }

        .search-bar+.btn:hover {
            color: var(--maocolor04);
        }

        .card-img-top {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 30px;
            padding: 10px 10px 0 10px;
        }

        .card {
            border-radius: 20px;
            box-shadow: rgba(0, 0, 0, 0.25) 0px 0.0625em 0.0625em, rgba(0, 0, 0, 0.25) 0px 0.125em 0.5em, rgba(255, 255, 255, 0.1) 0px 0px 0px 1px inset;
        }

        .card-body {
            margin-top: -10px;
            color: var(--maocolor05);
        }

        .profile-card {
            max-width: 350px;
            background-color: var(--maocolor08);
            border: 1px solid var(--maocolor01);
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .profile-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border: 4px solid var(--maocolor02);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .small-text {
            font-size: 0.85rem;
            color: var(--maocolor06);
        }

        .social-icons a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f8f9fa;
            color: #6c757d;
            text-decoration: none;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .social-icons a:hover {
            background-color: #007bff;
            color: #fff;
        }

        .btn-sm.rounded-circle {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-secondary {
            background-color: var(--maocolor07);
            border-color: var(--maocolor06);
            color: var(--maocolor05);
        }

        .btn-warning {
            background-color: var(--maocolor03);
            border-color: var(--maocolor01);
            color: var(--maocolor05);
        }

        .modal-content {
            background-color: var(--maocolor02);
            border: 1px solid var(--maocolor06);
        }

        .modal-header {
            background-color: var(--maocolor01);
            color: var(--maocolor05);
            border-bottom: 1px solid var(--maocolor06);
        }

        .modal-title {
            color: var(--maocolor05);
        }

        .modal-body {
            background-color: var(--maocolor02);
        }

        .form-control:disabled {
            background-color: var(--maocolor09);
            color: var(--maocolor07);
        }

        .form-text {
            color: var(--maocolor06);
        }

        .modal-footer {
            border-top: 1px solid var(--maocolor06);
        }

        .btn.btn-secondary {
            background-color: var(--maocolor07);
            border-color: var(--maocolor06);
            color: var(--maocolor05);
        }

        .btn.bg-02 {
            background-color: var(--maocolor03);
            border-color: var(--maocolor01);
            color: var(--maocolor05);          
        }

        .btn.bg-02:hover,
        .btn.btn-secondary:hover {
            background-color: var(--maocolor04);
        }

        .status-text {
            color: var(--maocolor05);
        }

        .container .form-control,
        .container .form-select {
            background-color: var(--maocolor08);
            border: 1px solid var(--maocolor06);
            color: var(--maocolor05);
        }
    </style>
</head>

<body>
    <div id="app">
        <nav class="navbar navbar-expand-lg navbar-dark bg-01">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">MAOMAO控制台</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                會員管理
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="userDropdown">
                                <li>
                                    <a class="dropdown-item" href="mao-users-control-panel_v1.html#registerModal"
                                        @click.prevent="openRegisterModal">會員建檔</a>
                                </li>
                                <li><a class="dropdown-item active" href="mao-users-control-panel_v1.html">會員列表</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="productDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                商品管理
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="productDropdown">
                                <li><a class="dropdown-item" href="mao-products-C-control-panel_v1.html">商品建檔</a></li>
                                <li><a class="dropdown-item" href="mao-products-R-control-panel_v1.html">商品列表</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="orderDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                訂單管理
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="orderDropdown">
                                <li><a class="dropdown-item " href="mao-orders-control-panel_v1.html">訂單列表</a></li>
                                <li><a class="dropdown-item" href="#">退貨處理</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="mao-chart-control-panel_v1.html"
                                id="reportDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                報表分析
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="reportDropdown">
                                <li><a class="dropdown-item" href="mao-chart-control-panel_v1.html#orders">銷售報表</a></li>
                                <li><a class="dropdown-item" href="mao-chart-control-panel_v1.html#users">會員分析</a></li>
                                <li><a class="dropdown-item" href="mao-chart-control-panel_v1.html#products">商品分析</a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="Mao-index_v1.html">回首頁</a></li>
                    </ul>
                    <div class="position-relative ms-auto">
                        <input type="text" class="form-control rounded-pill search-bar pe-5" placeholder="Search..."
                            aria-label="Search" v-model="searchQuery">
                        <button class="btn position-absolute top-50 end-0 translate-middle-y" type="button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-search" viewBox="0 0 16 16">
                                <path
                                    d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-02">
                        <h1 class="modal-title fs-5 fw-900 tx-05" id="registerModalLabel">會員註冊</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="username_reg" class="form-label">帳號</label>
                                    <input type="text" class="form-control" id="username_reg" v-model="newUser.Username"
                                        placeholder="3-8字數"
                                        :class="{ 'is-valid': usernameValid === true, 'is-invalid': usernameValid === false }">
                                    <div class="valid-feedback" v-if="usernameValid === true">符合規定</div>
                                    <div class="invalid-feedback" v-if="usernameValid === false">{{ usernameMessage }}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="password_reg" class="form-label">密碼</label>
                                    <input type="password" class="form-control" id="password_reg"
                                        v-model="newUser.Password" placeholder="3-6字數"
                                        :class="{ 'is-valid': passwordValid === true, 'is-invalid': passwordValid === false }">
                                    <div class="form-text">不會記錄任何資料</div>
                                    <div class="valid-feedback" v-if="passwordValid === true">符合規定</div>
                                    <div class="invalid-feedback" v-if="passwordValid === false">密碼需為 3-6 字</div>
                                </div>
                                <div class="mb-3 form-floating">
                                    <input type="password" class="form-control" id="re_password_reg"
                                        v-model="newUser.RePassword"
                                        :class="{ 'is-valid': rePasswordValid === true, 'is-invalid': rePasswordValid === false }">
                                    <label for="re_password_reg" class="form-label">再次輸入密碼</label>
                                    <div class="form-text">不會記錄任何資料</div>
                                    <div class="valid-feedback" v-if="rePasswordValid === true">密碼一致</div>
                                    <div class="invalid-feedback" v-if="rePasswordValid === false">密碼不一致</div>
                                </div>
                                <div class="mb-3 form-floating">
                                    <input type="text" class="form-control" id="email_reg" v-model="newUser.Email"
                                        placeholder="3-20字數"
                                        :class="{ 'is-valid': emailValid === true, 'is-invalid': emailValid === false }">
                                    <label for="email_reg" class="form-label">Email : example@example.com</label>
                                    <div class="valid-feedback" v-if="emailValid === true">符合規定</div>
                                    <div class="invalid-feedback" v-if="emailValid === false">請輸入有效 Email</div>
                                </div>
                                <div class="mb-3">
                                    <label for="level_reg" class="form-label">會員等級</label>
                                    <select class="form-select text-center" id="level_reg" v-model="newUser.Level">
                                        <option value="" selected disabled>----選擇會員等級----</option>
                                        <option value="10">一般會員</option>
                                        <option value="20">VIP 會員</option>
                                        <option value="30">VVIP 會員</option>
                                        <option value="100">管理員</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex flex-column h-100">
                                    <div class="mb-3">
                                        <label for="mycity" class="form-label">居住地</label>
                                        <select name="region" id="mycity" class="form-select text-center"
                                            v-model="newUser.Region" required>
                                            <option value="" selected disabled>----選擇縣市名稱----</option>
                                            <option v-for="city in cityList" :key="city" :value="city">{{ city }}
                                            </option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="photo_reg" class="form-label">個人頭像</label>
                                        <input type="file" class="form-control" id="photo_reg" accept="image/*"
                                            @change="previewRegImage"
                                            :class="{ 'is-valid': photoValid === true, 'is-invalid': photoValid === false }">
                                        <div class="valid-feedback" v-if="photoValid === true">圖片格式正確</div>
                                        <div class="invalid-feedback" v-if="photoValid === false">請選擇有效的圖片檔案</div>
                                        <div class="mt-3 text-center">
                                            <img v-if="regImagePreview" :src="regImagePreview"
                                                class="rounded rounded-circle"
                                                style="width: 250px; height: 250px; object-fit: cover; border-radius: 50%;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn bg-02" @click="registerUser" :disabled="isRegistering">
                            <span v-if="isRegistering">註冊中...</span>
                            <span v-else>確認</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="container my-4">
            <div class="row">
                <div class="col-md-3 mb-1">
                    <select v-model="selectedSort" class="form-control text-center">
                        <option value="newest">排序 : 新到舊</option>
                        <option value="oldest">排序 : 舊到新</option>
                    </select>
                </div>
                <div class="col-md-3 mb-1">
                    <select v-model="selectedLevel" class="form-control text-center">
                        <option value="all">全部會員</option>
                        <option value="10">一般會員</option>
                        <option value="20">VIP會員</option>
                        <option value="30">VVIP會員</option>
                        <option value="100">管理員</option>
                    </select>
                </div>
                <div class="col-md-3 mb-1">
                    <select v-model="selectedRegion" class="form-control text-center">
                        <option value="全部">全部</option>
                        <option v-for="type in uniqueTypes" :key="type" :value="type">
                            {{ type }}
                        </option>
                    </select>
                </div>
                <div class="col-md-3 mb-1">
                    <select v-model="selectedStatus" class="form-control text-center">
                        <option value="全部">狀態 : 全部</option>
                        <option value="Y">狀態 : 正常</option>
                        <option value="N">狀態 : 停權</option>
                    </select>
                </div>
            </div>
            <div v-if="filteredUsers && filteredUsers.length" class="row justify-content-center" id="mydata">
                <div class="col-lg-3 col-md-4 mt-3" v-for="item in filteredUsers" :key="item.User_id">
                    <div class="card profile-card">
                        <div class="card-body text-center">
                            <img :src="'uploads/users/' + item.Userphoto + '?t=' + Date.now()" alt="User Profile"
                                class="rounded-circle profile-img mb-2">
                            <h3 class="card-title mb-1" v-if="item.Username">{{ item.Username }}</h3>
                            <p class="card-text text-muted mb-1">{{ item.Email }}</p>
                            <p class="card-text mb-1">{{ getUserLevel(item.Level) }}</p>
                            <p class="card-text mb-1">居住地: {{ item.Region }}</p>
                            <p class="card-text mb-2 small-text">建檔時間: {{ item.Created_at }}</p>

                            <div class="d-flex justify-content-around mb-2">
                                <button class="btn btn-sm rounded-circle"
                                    :class="item.Status === 'Y' ? 'btn-success' : 'btn-secondary'" disabled>
                                    <i class="fas" :class="item.Status === 'Y' ? 'fa-check' : 'fa-ban'"></i>
                                </button>
                                <button class="btn btn-warning btn-sm rounded-circle" @click="openUpdateModal(item)"
                                    data-bs-toggle="modal" data-bs-target="#updateModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm rounded-circle" @click="deleteUser(item.User_id)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-02">
                            <h1 class="modal-title fs-5 fw-900 tx-05" id="updateModalLabel">會員資料更新</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="level_update" class="form-label">會員等級</label>
                                        <select class="form-select text-center" id="level_update"
                                            v-model="currentItem.Level">
                                            <option value="10">一般會員</option>
                                            <option value="20">VIP 會員</option>
                                            <option value="30">VVIP 會員</option>
                                            <option value="100">管理員</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="username_update" class="form-label">帳號</label>
                                        <input type="text" class="form-control" id="username_update"
                                            v-model="currentItem.Username"
                                            :class="{ 'is-valid': updateUsernameValid === true, 'is-invalid': updateUsernameValid === false }">
                                        <div class="valid-feedback" v-if="updateUsernameValid === true">符合規定</div>
                                        <div class="invalid-feedback" v-if="updateUsernameValid === false">{{
                                            updateUsernameMessage }}</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="email_update" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email_update"
                                            v-model="currentItem.Email"
                                            :class="{ 'is-valid': updateEmailValid === true, 'is-invalid': updateEmailValid === false }">
                                        <div class="valid-feedback" v-if="updateEmailValid === true">符合規定</div>
                                        <div class="invalid-feedback" v-if="updateEmailValid === false">請輸入有效 Email
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="mycity" class="form-label">居住地</label>
                                        <select name="region" id="mycity" class="form-select text-center"
                                            v-model="currentItem.Region" required>
                                            <option value="" selected disabled>----選擇縣市名稱----</option>
                                            <option v-for="city in cityList" :key="city" :value="city">{{ city }}
                                            </option>
                                        </select>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-3">
                                            <label for="status_update" class="form-label">狀態</label>
                                            <div class="checkbox-wrapper-9">
                                                <input class="tgl tgl-flat" id="status_update" type="checkbox"
                                                    v-model="currentItem.Status" :true-value="'Y'" :false-value="'N'" />
                                                <label class="tgl-btn" for="status_update"></label>
                                                <span class="status-text">
                                                    {{ currentItem.Status === 'Y' ? '正常' : '停權' }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-9">
                                            <label for="createdAt" class="form-label">建檔時間</label>
                                            <input type="text" id="createdAt" class="form-control"
                                                v-model="currentItem.Created_at" disabled>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-flex flex-column h-100">
                                        <div class="mb-3">
                                            <label for="photo_update" class="form-label">個人頭像</label>
                                            <input type="file" class="form-control" id="photo_update" accept="image/*"
                                                @change="previewImage">
                                            <div class="mt-3 text-center">
                                                <img v-if="imagePreview || currentItem.Userphoto"
                                                    :src="imagePreview || ('uploads/users/' + currentItem.Userphoto + '?t=' + Date.now())"
                                                    class="rounded-circle"
                                                    style="width: 200px; height: 200px; object-fit: cover;">
                                                <div class="form-text" v-if="selectedFileName">{{ selectedFileName
                                                    }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn bg-02" @click="updateUser" :disabled="isUpdating">
                                <span v-if="isUpdating">更新中...</span>
                                <span v-else>確認</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://unpkg.com/counterup2@2.0.2/dist/index.js">	</script>
    <script src="js/wow.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/mao-auth.js"></script>
    <script>
        const App = {
            data() {
                return {
                    users: [],
                    selectedRegion: "全部", 
                    selectedSort: "newest",
                    selectedStatus: "全部", 
                    selectedLevel: "all",
                    uid: null,
                    selectedFileName: "", 
                    searchQuery: "", 
                    isUpdating: false,     
                    cityList: [], 
                    isRegistering: false, 
                    regImagePreview: null,
                    usernameValid: null, 
                    usernameMessage: "", 
                    passwordValid: null,
                    rePasswordValid: null, 
                    emailValid: null, 
                    photoValid: null, 
                    originalUsername: "", 
                    updateUsernameValid: null, 
                    updateUsernameMessage: "", 
                    updateEmailValid: null, 
                    imagePreview: null,  
                    newUser: { 
                        Username: "",
                        Password: "",
                        RePassword: "",
                        Email: "",
                        Region: "",
                        Level: "",
                        PhotoFile: null 
                    },
                    currentItem: {  
                        User_id: "",
                        Username: "",
                        Email: "",
                        Region: "",
                        Level: "",
                        Userphoto: "",
                        Status: "", 
                        Created_at: "",
                        PhotoFile: null, 
                    }
                };
            },
            computed: {
                uniqueTypes() {
                    const vm = this;
                    return [...new Set(vm.users.map(item => item.Region))];
                },
                filteredUsers() {
                    const vm = this;
                    let filtered = vm.users;

                    if (vm.selectedRegion !== "全部") {
                        filtered = filtered.filter(item => item.Region === vm.selectedRegion);
                    }

                    if (vm.selectedLevel !== "all") {
                        filtered = filtered.filter(item => String(item.Level) === vm.selectedLevel);
                    }

                    if (vm.selectedStatus !== "全部") {
                        filtered = filtered.filter(item => item.Status === vm.selectedStatus);
                    }

                    if (vm.selectedSort === "newest") {
                        filtered = filtered.sort((a, b) => new Date(b.Created_at) - new Date(a.Created_at));
                    } else if (vm.selectedSort === "oldest") {
                        filtered = filtered.sort((a, b) => new Date(a.Created_at) - new Date(b.Created_at));
                    }

                    if (vm.searchQuery) {
                        const query = vm.searchQuery.toLowerCase();
                        filtered = filtered.filter(item =>
                            item.Username.toLowerCase().includes(query) ||
                            String(item.User_id).includes(query) ||
                            item.Region.toLowerCase().includes(query) ||
                            String(item.Level).includes(query)
                        );
                    }

                    return filtered;
                },
            },
            mounted() {
                this.fetchUserRegion(); 
                this.loadCityList();    
                if (window.location.hash === '#registerModal') {
                    const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
                    registerModal.show();

                    history.replaceState(null, null, window.location.pathname);
                }
            },
            watch: {
                'currentItem.Username': function (newValue) {
                    const vm = this;
                    if (newValue === vm.originalUsername) {
                        vm.updateUsernameValid = true; 
                        vm.updateUsernameMessage = "帳號未變更";
                        return;
                    }
                    if (newValue.length > 2 && newValue.length < 9) {
                        axios.post("mao-users-control-api_v1.php?action=checkuni_update", {
                            username: newValue,
                            user_id: vm.currentItem.User_id 
                        })
                            .then(response => {
                                vm.updateUsernameValid = response.data.state;
                                vm.updateUsernameMessage = response.data.message;
                            })
                            .catch(() => {
                                vm.updateUsernameValid = false;
                                vm.updateUsernameMessage = "檢查失敗，請稍後再試";
                            });
                    } else {
                        vm.updateUsernameValid = false;
                        vm.updateUsernameMessage = "帳號需為 3-8 字";
                    }
                },
                'currentItem.Email': function (newValue) {
                    const vm = this;
                    vm.updateEmailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newValue);
                },
                'newUser.Username': function (newValue) {
                    const vm = this;
                    if (newValue.length > 2 && newValue.length < 9) {
                        axios.post("mao-users-control-api_v1.php?action=checkuni", { username: newValue })
                            .then(response => {
                                vm.usernameValid = response.data.state;
                                vm.usernameMessage = response.data.message;
                            })
                            .catch(() => {
                                vm.usernameValid = false;
                                vm.usernameMessage = "檢查失敗，請稍後再試";
                            });
                    } else {
                        vm.usernameValid = false;
                        vm.usernameMessage = "帳號需為 3-8 字";
                    }
                },
                'newUser.Password': function (newValue) {
                    this.passwordValid = newValue.length >= 3 && newValue.length <= 6;
                },
                'newUser.RePassword': function (newValue) {
                    this.rePasswordValid = newValue === this.newUser.Password && this.passwordValid;
                },
                'newUser.Email': function (newValue) {
                    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    this.emailValid = emailPattern.test(newValue);
                },
            },
            methods: {
                getUserLevel(level) {
                    const levels = {
                        10: "一般會員",
                        20: "VIP",
                        30: "VVIP",
                        100: "管理員"
                    };
                    return levels[level] || "未知等級"; 
                },
                fetchUserRegion() {
                    axios.get("mao-users-control-api_v1.php?action=getalldata")
                        .then(response => {
                            if (response.data.state) {
                                this.users = response.data.data || [];
                            }
                        });
                },
                loadCityList() {
                    $.ajax({
                        type: "GET",
                        url: "js/CityCountyData.json",
                        dataType: "json",
                        success: (data) => {
                            this.cityList = data.map(item => item.CityName);  
                        },
                        error: function () {
                            Swal.fire({
                                title: "API 介接錯誤",
                                text: "無法載入縣市資料",
                                icon: "error"
                            });
                        }
                    });
                },
                previewImage(event) {
                    const vm = this;
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            vm.imagePreview = e.target.result;
                        };
                        reader.readAsDataURL(file);

                        vm.currentItem.PhotoFile = file;
                        vm.selectedFileName = file.name;
                    }
                },
                // 預覽圖片
                previewRegImage(event) {
                    const vm = this;
                    const file = event.target.files[0];
                    if (file) {
                        const validTypes = ['image/jpeg', 'image/png'];
                        vm.photoValid = validTypes.includes(file.type);
                        if (vm.photoValid) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                vm.regImagePreview = e.target.result;
                            };
                            reader.readAsDataURL(file);
                            vm.newUser.PhotoFile = file;
                        } else {
                            vm.regImagePreview = null;
                            vm.newUser.PhotoFile = null;
                        }
                    } else {
                        vm.photoValid = false;
                        vm.newUser.PhotoFile = null;
                    }
                },
                registerUser() {
                    const vm = this;
                    if (vm.isRegistering) return;
                    vm.isRegistering = true;

                    if (!vm.usernameValid || !vm.emailValid ) {
                        Swal.fire({ title: "請填寫完整且正確的資料!", icon: "warning" });
                        vm.isRegistering = false;
                        return;
                    }

                    const formData = new FormData();
                    formData.append("username", vm.newUser.Username);
                    formData.append("password", vm.newUser.Password);
                    formData.append("email", vm.newUser.Email);
                    formData.append("region", vm.newUser.Region);
                    formData.append("level", vm.newUser.Level);
                    if (vm.newUser.PhotoFile) {
                        formData.append("photo", vm.newUser.PhotoFile);
                    }

                    axios.post("mao-users-control-api_v1.php?action=register", formData, {
                        headers: { "Content-Type": "multipart/form-data" }
                    })
                        .then(response => {
                            if (response.data.state) {
                                Swal.fire({ title: "註冊成功!", icon: "success" })
                                    .then(() => {
                                        const modal = document.getElementById("registerModal");
                                        bootstrap.Modal.getInstance(modal).hide();
                                        vm.newUser = { Username: "", Password: "", RePassword: "", Email: "", Region: "", Level: "", PhotoFile: null };
                                        vm.usernameValid = null;
                                        vm.usernameMessage = "";
                                        vm.emailValid = null;
                                        vm.isRegistering = false;
                                        window.location.reload();
                                    });
                            } else {
                                Swal.fire({ title: "註冊失敗!", text: response.data.message, icon: "error" });
                                vm.isRegistering = false;
                            }
                        })
                        .catch(error => {
                            Swal.fire({ title: "發生錯誤", text: "請稍後再試", icon: "error" });
                            vm.isRegistering = false;
                        });
                },
                openRegisterModal() {
                    const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
                    registerModal.show();
                },
                openUpdateModal(item) {
                    this.currentItem = { ...item }; 
                    this.originalUsername = item.Username;
                    this.updateUsernameValid = null; 
                    this.updateEmailValid = item.Email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(item.Email); 
                    this.imagePreview = null; 
                },
                updateUser() {
                    const vm = this;
                    if (vm.isUpdating) return;
                    vm.isUpdating = true;

                    if (vm.updateUsernameValid === false || vm.updateEmailValid === false) {
                        Swal.fire({ title: "請填寫完整且正確的資料!", icon: "warning" });
                        vm.isUpdating = false;
                        return;
                    }

                    if (vm.currentItem.Status !== 'Y' && vm.currentItem.Status !== 'N') {
                        vm.currentItem.Status = 'Y';
                    }

                    const formData = new FormData();
                    formData.append("user_id", vm.currentItem.User_id);
                    formData.append("username", vm.currentItem.Username);
                    formData.append("email", vm.currentItem.Email);
                    formData.append("region", vm.currentItem.Region);
                    formData.append("level", vm.currentItem.Level);
                    formData.append("status", vm.currentItem.Status);
                    if (vm.currentItem.PhotoFile && vm.currentItem.PhotoFile instanceof File) {
                        formData.append("photo", vm.currentItem.PhotoFile);
                    }

                    axios.post("mao-users-control-api_v1.php?action=update", formData, {
                        headers: { "Content-Type": "multipart/form-data" }
                    })
                        .then(response => {
                            if (response.data.state) {
                                const index = vm.users.findIndex(user => user.User_id === vm.currentItem.User_id);
                                if (index !== -1) {
                                    vm.users[index] = { ...vm.users[index], ...response.data.data };
                                }
                                Swal.fire({ title: "更新成功!", icon: "success" })
                                    .then(() => {
                                        const modal = document.getElementById("updateModal");
                                        bootstrap.Modal.getInstance(modal).hide();
                                        vm.isUpdating = false;
                                        vm.imagePreview = null;
                                        vm.selectedFileName = '';
                                        vm.currentItem.PhotoFile = null;
                                    });
                            } else {
                                Swal.fire({ title: "更新失敗!", text: response.data.message, icon: "error" });
                                vm.isUpdating = false;
                            }
                        })
                        .catch(error => {
                            Swal.fire({ title: "發生錯誤", text: "請稍後再試", icon: "error" });
                            vm.isUpdating = false;
                        });
                },
                deleteUser(id) {
                    Swal.fire({
                        title: "確認刪除?",
                        text: "刪除後無法恢復!",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "確定刪除"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            axios.delete("mao-users-control-api_v1.php?action=delete", { data: { user_id: id } })
                                .then(response => {
                                    if (response.data.state) {
                                        Swal.fire("刪除成功!", "", "success");
                                        this.fetchUserRegion();
                                    } else {
                                        Swal.fire("刪除失敗", response.data.message, "error");
                                    }
                                })
                                .catch(error => {
                                });
                        }
                    });
                },
            }
        }
        Vue.createApp(App).mount('#app');
    </script>
</body>

</html>