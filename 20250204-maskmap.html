<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>口罩地圖 - 使用OSM</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="css/mao.css">
    <link rel="stylesheet" href="css/MarkerCluster.css">
    <style>
        .marker-cluster-medium{
            background-color:rgba(128, 255, 116, 0.4);
            border-radius: 50%;
        }
        .marker-cluster-medium div{
            background-color:rgba(128, 255, 116, 0.8);
        }
        .marker-cluster-small{
            background-color:rgba(116, 227, 255, 0.4);
            border-radius: 50%;
        }
        .marker-cluster-small div{
            background-color:rgba(116, 227, 255, 0.8);
        }
        .marker-cluster div{
            width: 30px;
            height: 30px;
            margin-top: 5px;
            margin-left: 5px;
            font-size: 16px;
            font-weight: 900;
            text-align: center;
            border-radius: 50%;
        }
        .marker-cluster div span{
            line-height: 30px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row vh-100">
            <div class="col-md-4 bg-02">
                <select name="" id="mycity" class="form-select form-select-lg text-center mt-3">
                    <option value="" selected disabled>----選擇縣市名稱----</option>
                    <option value="台北市">台北市</option>
                    <option value="台中市">台中市</option>
                    <option value="台南市">台南市</option>
                </select>
                <select name="" id="myarea" class="form-select form-select-lg text-center mt-3">
                    <option value="" selected disabled>---選擇鄉鎮區名稱---</option>
                </select>
                <ul class="list-group mt-3" id="mylist" style="height: 83vh; overflow: scroll;">
                </ul>
            </div>
            <div class="col-md-8 bg-04">
                <div id="map" style="height: 100vh;"></div>
            </div>
        </div>
    </div>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/points.json"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="js/leaflet.markercluster.js"></script>
    <script src="js//leaflet-color-markers.js"></script>
    <script src="js/mao-auth.js"></script>
    <script>
        var allCityData;  
        var allpoints;  
        var mycity;  
        var myarea;  
        var map;
        var markers;
        $(function () {
            map = L.map('map').setView([24.171479, 120.609480], 14);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            markers = new L.markerClusterGroup().addTo(map);

            $.ajax({
                type: "GET",
                url: "js/points.json",
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    allpoints = data.features;
                    console.log(allpoints);
                },
                error: function () {
                    Swal.fire({
                        title: "API 介接錯誤",
                        text: "js/points.json",
                        icon: "error"
                    });
                }
            });

            $.ajax({
                type: "GET",
                url: "js/CityCountyData.json",
                dataType: "json",
                success: function (data) {
                    allCityData = data;

                    $("#mycity").empty();
                    $("#mycity").append('<option value="" selected disabled>----選擇縣市名稱----</option>');
                    allCityData.forEach(function (item) {
                        var strHTML = `<option value="${item.CityName}">${item.CityName}</option>`;
                        $("#mycity").append(strHTML);
                    });
                },
                error: function () {
                    Swal.fire({
                        title: "API 介接錯誤",
                        text: "js/CityCountyData.json",
                        icon: "error"
                    });
                }
            });

            $("#mycity").change(function () {
                mycity = $(this).val();
                allCityData.forEach(function (item) {
                    if (item.CityName == mycity) {
                        $("#myarea").empty();
                        $("#myarea").append(' <option value="" class="text-center" selected disabled>---請選擇鄉鎮區名稱---</option> ');
                        item.AreaList.forEach(function (myitem) {
                            var strHTML = `<option value="${myitem.AreaName}">${myitem.AreaName}</option>`;
                            $("#myarea").append(strHTML);
                        });
                    }
                });
            });

            $("#myarea").change(function () {
                myarea = $(this).val();
                $("#mylist").empty();
                removeMarker();
                var counter = 0;
                allpoints.forEach(function (item) {
                    if (item.properties.county == mycity && item.properties.town == myarea) {
                        counter++;
                        if (counter == 1) {
                            map.panTo([item.geometry.coordinates[1], item.geometry.coordinates[0]]);
                        }
                        var strHTML = `<li class="list-group-item" data-name="${item.properties.name}" data-address="${item.properties.address}" data-phone="${item.properties.phone}" data-mask_adult="${item.properties.mask_adult}" data-mask_child="${item.properties.mask_child}" data-lat="${item.geometry.coordinates[1]}" data-lng="${item.geometry.coordinates[0]}">
                        <p class="h3 fw-900 text-warning">${item.properties.name}</p>
                        <p class="h5 fw-900">地址:${item.properties.address}</p>
                        <p class="h5 fw-900">電話:${item.properties.phone}</p>
                        <p class="h5 fw-900">成人: <span class="h2 fw-900 text-success">${item.properties.mask_adult}</span> 個</p>
                        <p class="h5 fw-900">兒童: <span class="h2 fw-900 text-info">${item.properties.mask_child}</span> 個</p></li>`;
                        $("#mylist").append(strHTML);

                        var popupHTML = `<div class="card">
                                            <div class="card-header h2 fw-900 bg-06">藥局名稱</div>
                                            <div class="card-body">
                                                <p class="h3 fw-900 text-warning">${item.properties.name}</p>
                                                <p class="h5 fw-900">地址:${item.properties.address}</p>
                                                <p class="h5 fw-900">電話:${item.properties.phone}</p>
                                                <p class="h5 fw-900">成人: <span class="h2 fw-900 text-success">${item.properties.mask_adult}</span> 個</p>
                                                <p class="h5 fw-900">兒童: <span class="h2 fw-900 text-info">${item.properties.mask_child}</span> 個</p>
                                            </div>
                                        </div>`;
                        markers.addLayer(L.marker([item.geometry.coordinates[1], item.geometry.coordinates[0]], {icon: FishBlueIcon}).bindPopup(popupHTML));
                    }
                });

                $("#mylist .list-group-item").click(function () {
                    console.log($(this).data("name"));
                    console.log($(this).data("address"));
                    console.log($(this).data("phone"));
                    console.log($(this).data("mask_adult"));
                    console.log($(this).data("mask_child"));
                    console.log($(this).data("lat"));
                    console.log($(this).data("lng"));
                    markerPopup($(this).data("name"), $(this).data("address"), $(this).data("phone"), $(this).data("mask_adult"), $(this).data("mask_child"), $(this).data("lat"), $(this).data("lng"));
                });
            });

        });

        function removeMarker() {
            map.eachLayer(function (layer) {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
        }

        function markerPopup(name, address, phone, mask_adult, mask_child, lat, lng) {
            var popupHTML = `<div class="card">
                                <div class="card-header h2 fw-900 bg-06">藥局名稱</div>
                                <div class="card-body">
                                    <p class="h3 fw-900 text-warning">${name}</p>
                                    <p class="h5 fw-900">地址:${address}</p>
                                    <p class="h5 fw-900">電話:${phone}</p>
                                    <p class="h5 fw-900">成人: <span class="h2 fw-900 text-success">${mask_adult}</span> 個</p>
                                    <p class="h5 fw-900">兒童: <span class="h2 fw-900 text-info">${mask_child}</span> 個</p>
                                </div>
                            </div>`;
            L.marker([lat, lng]).addTo(map).bindPopup(popupHTML).openPopup();
        }
    </script>
</body>


</html>